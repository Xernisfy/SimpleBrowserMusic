<!doctype html>
<html>

<head>
  <title>Music player</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <script type="text/javascript">(function () {
      'use strict';
      document.addEventListener('DOMContentLoaded', function () {
        // helper function to assign multiple properties to an object
        function set(e, as) {
          for (let a in as) {
            if (as[a].constructor.name === 'Object') {
              set(e[a], as[a]);
            } else {
              e[a] = as[a];
            }
          }
        }
        // helper function to create elements
        function create(t, p, a) {
          const e = document.createElement(t);
          if (p) {
            p.appendChild(e);
          }
          if (a) {
            set(e, a);
          }
          return e;
        }
        // helper function to send an XMLHttpRequest
        function xhr(file) {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', file);
          xhr.overrideMimeType('text/plain');
          xhr.addEventListener('loadend', () => {
            if (xhr.status === 200) {
              listFiles(xhr.response);
            }
          });
          xhr.send();
        }
        // helper function to create a gradient background for sliders
        function sliderGradient(element, color) {
          let width = element.getBoundingClientRect().width;
          let line = element.value / element.max * 100 * ((width - 16) / width) + (800 / width);
          let colorStops = [
            color + ' ' + line + '%',
            'transparent ' + line + '%'
          ];
          element.style.backgroundImage = 'linear-gradient(to right, ' + colorStops.join(', ') + ')';
        }
        // helper function to create a slider specifically
        function createSlider(p, a, w, h, color) {
          const box = create('div', p, {
            style: {
              display: 'inline-block',
              position: 'relative',
              width: w + 'px',
              height: h + 'px',
              overflow: 'hidden'
            }
          });
          const slider = create('input', box, {
            type: 'range',
            style: {
              position: 'absolute',
              width: '100%',
              height: '100%'
            }
          });
          create('div', box, {
            style: {
              content: '',
              position: 'absolute',
              left: '-8px',
              top: '-16px',
              width: (w - 16) + 'px',
              height: h + 'px',
              border: '16px solid white',
              borderRadius: '200px',
              pointerEvents: 'none'
            }
          });
          set(slider, a);
          sliderGradient(slider, color);
          return slider;
        }
        // create a 'select' element, include all given elements as 'option's and save the according audios
        function listFiles(list) {
          let options, option;
          select = create('select', document.body);
          options = list.split('\n');
          for (let o = 0; o < options.length; o++) {
            if (options[o] !== '') {
              option = create('option', select, {
                value: o,
                innerText: options[o]
              });
              audios.push(audio(options[o]));
            }
          }
        }
        // turn a relative path to an mp3 file into an audio element
        // (loading of the actual sound file apparently starts asynchronous once this element is created)
        function audio(file) {
          const audio = create('audio', false, {
            preload: 'none'
          });
          create('source', audio, {
            src: file,
            type: 'audio/mpeg'
          });
          return audio;
        }
        // update the timeline with the current time
        function update() {
          set(timeline, {
            value: currentAudio.currentTime,
            max: currentAudio.duration
          });
          sliderGradient(timeline, 'limegreen')
        }
        function changeTrack(idx) {

        }
        let select, audios = [], currentAudio, currentAudioIdx, interval;
        // play button
        const play = create('button', document.body, {
          innerText: String.fromCharCode(0x23F5) // 'play'
        });
        play.addEventListener('click', () => {
          if (currentAudioIdx != select.value) {
            if (currentAudio) {
              currentAudio.pause();
            }
            currentAudio = undefined;
          }
          if (!currentAudio) {
            currentAudio = audios[parseInt(select.value)].cloneNode(true);
            currentAudio.volume = volume.value;
            currentAudio.loop = Boolean(parseInt(loop.dataset.active));
            currentAudioIdx = select.value;
            set(timeline, {
              value: currentAudio.currentTime,
              max: currentAudio.duration
            });
            currentAudio.addEventListener('durationchange', update);
            currentAudio.addEventListener('timeupdate', update);
          }
          currentAudio.play();

        });
        // pause button
        const pause = create('button', document.body, {
          innerText: String.fromCharCode(0x23F8) // 'pause'
        });
        pause.addEventListener('click', () => {
          if (currentAudio) {
            currentAudio.pause();
          }
          if (interval) {
            clearInterval(interval);
          }
        });
        // previous button
        const previous = create('button', document.body, {
          innerText: String.fromCharCode(0x23EE)
        });
        previous.addEventListener('click', () => {
          if (currentAudio) {
            currentAudio.pause();
          }
        });
        // next button
        // shuffle button
        // loop button
        const loop = create('button', document.body, {
          innerText: String.fromCharCode(0x2B6E), // 'loop'
          dataset: {
            active: '1'
          }
        });
        loop.addEventListener('click', () => {
          set(loop, {
            dataset: {
              active: 1 - parseInt(loop.dataset.active)
            },
            style: {
              color: Boolean(parseInt(loop.dataset.active)) ? 'grey' : 'black'
            }
          });
          if (currentAudio) {
            currentAudio.loop = Boolean(parseInt(loop.dataset.active));
          }
        });
        // cross-fade button
        /*
        const cross = create('button', document.body, {
          innerText: String.fromCharCode(0x292E) // intertwined arrows
        });
        */
        // volume slider
        const volume = createSlider(document.body, {
          min: 0,
          max: 1,
          step: 0.01,
          value: 1
        }, 100, 8, 'royalblue');
        volume.addEventListener('input', () => {
          if (currentAudio) {
            currentAudio.volume = volume.value;
          }
          set(volumeDisplay, {
            innerText: Math.floor(volume.value * 100) + '%'
          });
          sliderGradient(volume, 'royalblue');
        });
        // volume display
        const volumeDisplay = create('span', document.body, {
          innerText: (volume.value * 100) + '%',
          style: {
            display: 'inline-block',
            width: '40px',
            textAlign: 'right',
            padding: '0px 8px'
          }
        });
        // timeline
        const timeline = createSlider(document.body, {
          min: 0.0,
          max: 1.0,
          step: 0.000001,
          value: 0.0
        }, 600, 8, 'limegreen');
        timeline.addEventListener('input', () => {
          if (currentAudio) {
            currentAudio.currentTime = timeline.value;
            update();
          }
        });
        // request the file containing the relative paths to all the audio files
        xhr('music.txt');
      });
    })();</script>
  <style type="text/css">
    * {
      font-family: 'Segoe UI', sans-serif;
    }

    input {
      padding: 0px;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
    }

    input[type="range"]::-moz-range-track {
      background-color: transparent;
    }

    input[type="range"]::-moz-range-thumb {
      border-color: transparent;
      background-color: transparent;
    }
  </style>
</head>

<body></body>

</html>
